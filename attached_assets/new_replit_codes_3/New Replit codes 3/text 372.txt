import os
import subprocess
from pathlib import Path
from flask import Flask, request, render_template_string, jsonify
from dotenv import load_dotenv
load_dotenv()

import sys
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "..")))
from desktop.webui.agent_loader import load_agent

PORT = int(os.getenv("PORT", "7860"))
agent = load_agent()

# ---------- status helpers ----------
def read_env_var(key, default=""):
    val = os.getenv(key)
    if val is not None:
        return val
    envp = Path(".env")
    if envp.exists():
        for line in envp.read_text(encoding="utf-8").splitlines():
            if "=" in line and not line.strip().startswith("#"):
                k, v = line.split("=", 1)
                if k.strip() == key:
                    return v.strip()
    return default

def detect_status():
    """
    Returns:
      {"status":"ok|cpu|missing|error", "backend":"cuda|rocm|metal|cpu|unknown",
       "model":"name", "details":"..."}
    """
    model_path = read_env_var("AGENT_MODEL", "gguf/llama-3.1-8b-q4_0.gguf")
    model_exists = Path(model_path).exists()
    backend = "unknown"
    details = ""
    try:
        out = subprocess.check_output([sys.executable, "scripts/gpu_detect.py"], text=True, timeout=6)
        for line in out.splitlines():
            if line.startswith("Backend:"):
                backend = line.split(":", 1)[1].strip()
                break
    except Exception as e:
        details = f"gpu_detect error: {e}"

    if not model_exists:
        return {"status": "missing", "backend": backend, "model": Path(model_path).name, "details": "Model file not found"}

    if backend in ("cuda", "rocm", "metal"):
        return {"status": "ok", "backend": backend, "model": Path(model_path).name, "details": details or "accelerated"}
    if backend in ("cpu", "unknown"):
        return {"status": "cpu", "backend": backend, "model": Path(model_path).name, "details": details or "CPU mode"}
    return {"status": "error", "backend": backend, "model": Path(model_path).name, "details": details or "unknown"}

def play_ping(ok: bool, msg: str = ""):
    """Delegates to post_tune_ping.py for WAV/TTS."""
    script = Path("scripts/post_tune_ping.py")
    if not script.exists():
        return {"played": False, "reason": "post_tune_ping.py not found"}
    try:
        if ok:
            subprocess.run([sys.executable, str(script)], check=False)
        else:
            subprocess.run([sys.executable, str(script), "--error", msg or "Triggered error ping"], check=False)
        return {"played": True}
    except Exception as e:
        return {"played": False, "reason": str(e)}

def speak_status_message():
    """Compose a friendly TTS status line and speak it via post_tune_ping.py --say."""
    stat = detect_status()
    ctx = read_env_var("LLM_CTX", "n/a")
    th  = read_env_var("LLM_THREADS", "n/a")
    msg = (
        f"Supersonic status {stat['status']}. "
        f"Backend {stat['backend']}. "
        f"Model {stat['model']}. "
        f"Context {ctx}. Threads {th}."
    )
    script = Path("scripts/post_tune_ping.py")
    if not script.exists():
        return {"spoken": False, "reason": "post_tune_ping.py not found"}
    try:
        subprocess.run([sys.executable, str(script), "--say", msg], check=False)
        return {"spoken": True, "message": msg}
    except Exception as e:
        return {"spoken": False, "reason": str(e)}

# ---------- HTML ----------
TPL = '''
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Supersonic Local</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:20px; }
    .bar { display:flex; align-items:center; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
    .led { width:12px; height:12px; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,.25); }
    .led.ok { background:#10b981; }      /* green */
    .led.cpu { background:#f59e0b; }     /* amber */
    .led.missing, .led.error { background:#ef4444; } /* red */
    .tag { padding:2px 8px; border-radius:999px; font-size:12px; background:#111; color:#fff; }
    .muted { color:#666; font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[name="q"] { width:70%; padding:8px; font-size:14px; }
    button { padding:8px 12px; font-size:14px; }
    pre { background:#0b0b0b; color:#e5e7eb; padding:12px; border-radius:8px; white-space:pre-wrap; }
    .pill { border:1px solid #333; background:#171717; color:#e5e7eb; border-radius:8px; }
  </style>
</head>
<body>
  <div class="bar">
    <div id="led" class="led cpu" title="status"></div>
    <div id="statusText" class="muted">Status: checking‚Ä¶</div>
    <span id="backend" class="tag">backend: ‚Ä¶</span>
    <span id="model" class="tag">model: ‚Ä¶</span>
    <button class="pill" onclick="pingSound(true)"  title="Play success chime">Test ‚úÖ</button>
    <button class="pill" onclick="pingSound(false)" title="Play error chime">Test ‚ùå</button>
    <button class="pill" onclick="speakStatus()" title="Speak current status">Speak üó£Ô∏è</button>
  </div>

  <div class="row">
    <form method="post" action="/ask">
      <input name="q" placeholder="Ask the agent‚Ä¶"/>
      <button>Ask</button>
    </form>
    <form action="/api/ingest" method="post" style="margin-left:4px;">
      <button title="Ingest docs from DOCS_DIR">Ingest Docs</button>
    </form>
  </div>

  <pre id="resp">{{ resp }}</pre>

<script>
async function refreshStatus(){
  try{
    const r = await fetch('/api/status');
    const j = await r.json();
    const led = document.getElementById('led');
    const st  = document.getElementById('statusText');
    const be  = document.getElementById('backend');
    const md  = document.getElementById('model');

    led.className = 'led ' + j.status;
    st.textContent = `Status: ${j.status}${j.details ? ' ‚Äî ' + j.details : ''}`;
    be.textContent = `backend: ${j.backend}`;
    md.textContent = `model: ${j.model || 'n/a'}`;
  }catch(e){
    const led = document.getElementById('led');
    const st  = document.getElementById('statusText');
    led.className = 'led error';
    st.textContent = 'Status: error ‚Äî cannot reach /api/status';
  }
}
refreshStatus();
setInterval(refreshStatus, 3000);

async function pingSound(ok){
  try{
    const r = await fetch('/api/status/sound?ok='+(ok ? '1' : '0') + (ok ? '' : '&msg=Manual%20error%20test'), {method:'POST'});
    const j = await r.json();
    if(!j.played){ console.warn('sound not played:', j.reason); }
  }catch(e){
    console.warn('sound error', e);
  }
}

async function speakStatus(){
  try{
    const r = await fetch('/api/status/speak', {method:'POST'});
    const j = await r.json();
    if(!j.spoken){ console.warn('speak failed:', j.reason); }
  }catch(e){
    console.warn('speak error', e);
  }
}
</script>
</body>
</html>
'''

app = Flask(__name__)

@app.route("/", methods=["GET"])
def index():
    return render_template_string(TPL, resp="")

@app.route("/ask", methods=["POST"])
def ask():
    q = request.form.get("q","").strip()
    out = agent.query(q)
    return render_template_string(TPL, resp=out)

@app.route("/api/ingest", methods=["POST"])
def ingest():
    status = "ingested"
    try:
        d = Path(os.getenv("DOCS_DIR","docs"))
        status = agent.ingest_dir(d)
    except Exception as e:
        status = f"error: {e}"
    return jsonify({"status": status})

@app.route("/api/status", methods=["GET"])
def api_status():
    return jsonify(detect_status())

@app.route("/api/status/sound", methods=["POST"])
def api_status_sound():
    ok = request.args.get("ok", "1") in ("1","true","True","yes","y")
    msg = request.args.get("msg", "")
    res = play_ping(ok, msg)
    return jsonify(res)

@app.route("/api/status/speak", methods=["POST"])
def api_status_speak():
    res = speak_status_message()
    return jsonify(res)

if __name__ == "__main__":
    app.run(host="127.0.0.1", port=PORT, debug=False)