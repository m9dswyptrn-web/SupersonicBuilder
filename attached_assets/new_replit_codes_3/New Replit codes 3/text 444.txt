<script>
let _reloading = false;

function setReloadBtnBusy(busy){
  const btn = document.getElementById('reloadBtn');
  if(!btn) return;
  _reloading = !!busy;
  btn.disabled = _reloading;
  btn.setAttribute('aria-busy', String(_reloading));
  btn.textContent = _reloading ? 'Reloading… ♻️' : 'Reload (hot) ♻️';
}

async function waitForHealth(maxMs=30000, intervalMs=1000){
  const deadline = Date.now() + maxMs;
  while(Date.now() < deadline){
    try{
      const r = await fetch('/api/healthz', {cache:'no-store'});
      if (r.ok) return true;
    }catch(e){}
    await new Promise(res => setTimeout(res, intervalMs));
  }
  return false;
}

async function reloadNow(){
  if(_reloading) return;
  setReloadBtnBusy(true);

  // lock entire header, but leave the reload button itself showing busy
  setHeaderPillsDisabled(true, 'reloadBtn');

  try{
    showToast('Reloading…');
    await fetch('/api/reload', { method: 'POST' });

    const ok = await waitForHealth(45000, 1000);
    if (ok) {
      location.reload();
      return; // page will reload
    } else {
      showToast('Still restarting… (you can refresh manually)');
    }
  }catch(e){
    console.warn('reloadNow error', e);
    showToast('Reload failed');
  }finally{
    setReloadBtnBusy(false);
    setHeaderPillsDisabled(false);
  }
}
</script>