<script>
let _reloading = false;

function setReloadBtnBusy(busy){
  const btn = document.getElementById('reloadBtn');
  if(!btn) return;
  _reloading = !!busy;
  btn.disabled = _reloading;
  btn.setAttribute('aria-busy', String(_reloading));
  btn.textContent = _reloading ? 'Reloading… ♻️' : 'Reload (hot) ♻️';
}

async function waitForHealth(maxMs=30000, intervalMs=1000){
  const deadline = Date.now() + maxMs;
  while(Date.now() < deadline){
    try{
      const r = await fetch('/api/healthz', {cache:'no-store'});
      if (r.ok) return true;
    }catch(e){ /* server still down, keep polling */ }
    await new Promise(res => setTimeout(res, intervalMs));
  }
  return false;
}

async function reloadNow(){
  if(_reloading) return;              // prevent double-taps
  setReloadBtnBusy(true);
  try{
    showToast('Reloading…');
    // Tell the app to exit; supervisor will relaunch
    await fetch('/api/reload', { method: 'POST' });

    // Poll until the server is back, then hard-reload to rebind sockets/state
    const ok = await waitForHealth(45000, 1000);
    if (ok) {
      location.reload();
    } else {
      showToast('Still restarting… (manual refresh may be needed)');
      setReloadBtnBusy(false); // let user try again
    }
  }catch(e){
    console.warn('reloadNow error', e);
    showToast('Reload failed');
    setReloadBtnBusy(false);
  }
}
</script>