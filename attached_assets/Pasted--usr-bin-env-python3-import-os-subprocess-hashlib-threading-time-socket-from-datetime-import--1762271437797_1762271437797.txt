#!/usr/bin/env python3
import os, subprocess, hashlib, threading, time, socket
from datetime import datetime
from fastapi import APIRouter
from pydantic import BaseModel

router = APIRouter(prefix="/api", tags=["sync"])

BOOT_TIME = time.time()

STATE = {
    "last_started": None,
    "last_finished": None,
    "last_ok": None,
    "last_msg": "never run",
    "last_commit": None,
}

# ---------- helpers ----------

def sh(cmd: str, check: bool = True) -> str:
    p = subprocess.run(cmd, shell=True, text=True,
                       stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    if check and p.returncode != 0:
        raise RuntimeError(f"$ {cmd}\n{p.stdout}")
    return p.stdout

def _ensure_git_identity():
    name  = os.getenv("GIT_AUTHOR_NAME",  "SonicBuilder Bot")
    email = os.getenv("GIT_AUTHOR_EMAIL", "bot@sonicbuilder.local")
    sh(f'git config user.name "{name}"')
    sh(f'git config user.email "{email}"')

def _detect_default_branch() -> str:
    try:
        out = sh("git symbolic-ref refs/remotes/origin/HEAD", check=False).strip()
        if out and "/" in out:
            return out.split("/")[-1]
    except Exception:
        pass
    # fallbacks
    for b in ("main", "master"):
        if sh(f"git rev-parse --verify {b}", check=False).strip():
            return b
    return "main"

def _commit_any_changes():
    sh("git add -A")
    status = sh("git status --porcelain").strip()
    if status:
        ts = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
        tree = sh("git write-tree").strip()
        digest = hashlib.sha1(tree.encode()).hexdigest()[:8]
        msg = f"[sync] Replit auto-sync @ {ts} (tree {digest})"
        sh(f'git commit -m "{msg}"')
        STATE["last_commit"] = msg
    else:
        STATE["last_commit"] = "(no local changes)"

def _pull_reconcile_push(branch: str):
    sh("git fetch --prune")
    sh(f"git checkout -B {branch}")
    out = sh(f"git merge --ff-only origin/{branch}", check=False)
    if "fatal:" in out or "not something we can merge" in out:
        rebase = sh(f"git rebase origin/{branch}", check=False)
        if "CONFLICT" in rebase:
            sh("git rebase --abort", check=False)
            sh(f"git merge --no-edit origin/{branch}", check=True)
    sh(f"git push --set-upstream origin {branch}")

def _run_sync():
    _ensure_git_identity()
    branch = _detect_default_branch()
    _commit_any_changes()
    _pull_reconcile_push(branch)

def _sync_job():
    try:
        STATE["last_started"]  = datetime.utcnow().isoformat() + "Z"
        _run_sync()
        STATE["last_ok"]  = True
        STATE["last_msg"] = "sync completed"
    except Exception as e:
        STATE["last_ok"]  = False
        STATE["last_msg"] = str(e)
    finally:
        STATE["last_finished"] = datetime.utcnow().isoformat() + "Z"

# ---------- models ----------

class SyncQueued(BaseModel):
    queued: bool
    message: str

class PingOut(BaseModel):
    ok: bool
    status: str
    ts: str
    uptime_sec: int
    host: str
    git: dict
    sync: dict
    env: dict

# ---------- endpoints ----------

@router.post("/sync", response_model=SyncQueued, status_code=202)
def api_sync_now():
    t = threading.Thread(target=_sync_job, daemon=True)
    t.start()
    return SyncQueued(queued=True, message="Sync started")

@router.get("/status")
def api_status():
    return STATE

@router.get("/ping", response_model=PingOut)
def api_ping():
    # git info (best-effort)
    def safe(cmd, default=""):
        try:
            return sh(cmd, check=False).strip()
        except Exception:
            return default

    branch = _detect_default_branch()
    remote = safe("git remote get-url origin")
    head   = safe("git rev-parse --short HEAD")
    dirty  = bool(safe("git status --porcelain"))
    last   = safe("git log -1 --pretty=%cI || true")

    # readiness (green/yellow/red -> map to ok/status)
    if STATE["last_ok"] is True:
        status = "green"
        ok = True
    elif STATE["last_ok"] is False:
        status = "red"
        ok = False
    else:
        status = "yellow"  # never run yet
        ok = True  # app is up, just no sync history

    env = {
        "repo": os.getenv("GITHUB_REPOSITORY", ""),
        "gh_token": "present" if os.getenv("GH_TOKEN") or os.getenv("GITHUB_TOKEN") else "missing",
        "port": os.getenv("PORT", ""),
        "mode": os.getenv("APP_MODE", "prod"),
    }

    return PingOut(
        ok=ok,
        status=status,
        ts=datetime.utcnow().isoformat() + "Z",
        uptime_sec=int(time.time() - BOOT_TIME),
        host=socket.gethostname(),
        git={"branch": branch, "remote": remote, "head": head, "dirty": dirty, "last_commit_time": last},
        sync={
            "last_started": STATE["last_started"],
            "last_finished": STATE["last_finished"],
            "last_ok": STATE["last_ok"],
            "last_msg": STATE["last_msg"],
            "last_commit": STATE["last_commit"],
        },
        env=env,
    )