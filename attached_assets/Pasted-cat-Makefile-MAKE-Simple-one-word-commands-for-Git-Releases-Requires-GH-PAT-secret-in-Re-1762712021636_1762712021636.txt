cat > Makefile <<'MAKE'
# Simple one-word commands for Git + Releases
# Requires GH_PAT secret in Replit (fine-grained or classic with repo: read/write)

SHELL := /bin/bash
BRANCH ?= main
TAG    ?=            # for 'make release TAG=v2.3.4'

.PHONY: help
help:
	@echo "Commands:"
	@echo "  make check             -> verify GH_PAT and remote"
	@echo "  make push              -> push current branch with temp token"
	@echo "  make push-tags         -> push tags with temp token"
	@echo "  make release-patch     -> bump patch, tag, push"
	@echo "  make release-minor     -> bump minor, tag, push"
	@echo "  make release-major     -> bump major, tag, push"
	@echo "  make release TAG=vX.Y.Z -> create that exact tag and push"
	@echo "  make clean-remote      -> restore clean https origin (no token in URL)"

.PHONY: check
check:
	@tools/verify_github_ready.sh

.PHONY: _auth _restore
_auth:
	@tools/git_auth.sh

_restore:
	@CLEAN_URL="$$(git config --get remote.origin.url | sed 's#^https\?://x-access-token:[^@]*@#https://#')" ; \
	[[ -z "$$CLEAN_URL" ]] && CLEAN_URL="$$(git config --get remote.origin.url)"; \
	git remote set-url origin "$$CLEAN_URL" ; \
	echo "üîÅ origin restored to: $$CLEAN_URL"

.PHONY: push
push: _auth
	@git push origin HEAD:$(BRANCH)
	@$(MAKE) -s _restore

.PHONY: push-tags
push-tags: _auth
	@git fetch --tags
	@git push origin --tags
	@$(MAKE) -s _restore

.PHONY: release-patch release-minor release-major
release-patch:
	@BRANCH=$(BRANCH) tools/release_now.sh --patch --push-branch

release-minor:
	@BRANCH=$(BRANCH) tools/release_now.sh --minor --push-branch

release-major:
	@BRANCH=$(BRANCH) tools/release_now.sh --major --push-branch

.PHONY: release
release:
	@[ -n "$(TAG)" ] || (echo "Usage: make release TAG=vX.Y.Z" && exit 2)
	@BRANCH=$(BRANCH) tools/release_now.sh --tag "$(TAG)" --push-branch

.PHONY: clean-remote
clean-remote:
	@CLEAN_URL="$$(git config --get remote.origin.url | sed 's#^https\?://x-access-token:[^@]*@#https://#')" ; \
	[[ -z "$$CLEAN_URL" ]] && CLEAN_URL="$$(git config --get remote.origin.url)"; \
	git remote set-url origin "$$CLEAN_URL" ; \
	echo "üßº origin cleaned: $$CLEAN_URL"
MAKE