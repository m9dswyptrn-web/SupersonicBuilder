name: Release Guard
on:
  workflow_dispatch:
    inputs:
      OVERRIDE:
        description: 'Bypass guard'
        required: false
        default: 'false'
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: read

jobs:
  guard:
    if: >
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.check.outputs.ok }}
    steps:
      - name: Check label on merged PR (docs:ready)
        id: check
        env:
          OVERRIDE: ${{ inputs.OVERRIDE || 'false' }}
        run: |
          if [ "$OVERRIDE" = "true" ]; then
            echo "ok=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          labels='${{ toJson(github.event.pull_request.labels) }}'
          echo "Labels: $labels"
          echo "$labels" | grep -qi '"name":"docs:ready"' && pass=1 || pass=0
          if [ $pass -eq 1 ]; then echo "ok=true" >> $GITHUB_OUTPUT; else echo "ok=false" >> $GITHUB_OUTPUT; fi
      - name: Fail if not ready
        if: steps.check.outputs.ok != 'true'
        run: |
          echo "‚ùå Release blocked: missing docs:ready label on the merged PR."
          exit 1
