name: pr-docs-ready-command

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  docs_ready_command:
    if: ${{ github.event.comment.body == '/docs-ready' && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate commenter permissions
        uses: actions/github-script@v7
        id: check
        with:
          script: |
            const {owner, repo} = context.repo;
            const username = context.payload.comment.user.login;
            const {data: perm} = await github.rest.repos.getCollaboratorPermissionLevel({
              owner, repo, username
            });
            if (perm.permission !== 'admin' && perm.permission !== 'write') {
              core.setFailed(`❌ ${username} lacks maintainer rights.`);
            } else {
              core.info(`✅ ${username} is authorized.`);
            }

      - name: Apply docs:ready label (if authorized)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.payload.issue.number;
            const labelName = 'docs:ready';
            try {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [labelName] });
              core.info(`Applied '${labelName}' label to PR #${issue_number}`);
            } catch (err) {
              core.warning(err);
            }

      - name: Acknowledge with reaction
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            await github.rest.reactions.createForIssueComment({
              owner, repo,
              comment_id: context.payload.comment.id,
              content: "rocket"
            });
