name: Docs Smoke Test (Pages)

on:
  workflow_run:
    workflows: ["Docs Release"]        # your existing docs release workflow name
    types: [completed]
  workflow_dispatch: {}                 # allow manual runs

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run smoke test
        env:
          SMOKE_URL: "https://m9dswyptrn-web.github.io/SonicBuilder/docs/images/mobo_back/gallery.html"
          SMOKE_TIMEOUT: "12"
          SMOKE_RETRIES: "3"
          SMOKE_RETRY_SLEEP: "2.0"
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}   # optional
          SLACK_WEBHOOK_URL:   ${{ secrets.SLACK_WEBHOOK_URL }}     # optional
          EMAIL_WEBHOOK_URL:   ${{ secrets.EMAIL_WEBHOOK_URL }}     # optional
          SMOKE_ARTIFACT: "smoke_diagnostics.json"
        run: |
          chmod +x scripts/test_gallery_http_smoke.py
          python scripts/test_gallery_http_smoke.py

      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: docs-smoke-diagnostics
          path: |
            smoke_diagnostics.json
            smoke_webhook_results.json
          if-no-files-found: ignore

      - name: Job summary
        if: always()
        run: |
          echo "### Docs Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target: https://m9dswyptrn-web.github.io/SonicBuilder/docs/images/mobo_back/gallery.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat smoke_diagnostics.json >> $GITHUB_STEP_SUMMARY || echo '{"info":"no diagnostics file"}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
