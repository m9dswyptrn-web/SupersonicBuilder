name: docs-release-status-badge
on:
  workflow_run:
    workflows: ["docs-release"]
    types: [completed]
  schedule:
    - cron: '15 */6 * * *'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update-badge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Evaluate required assets for latest release
        id: assets
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            
            // 1) Load requirements: prefer repo var SB_REQUIRED_ASSETS_PATTERNS, then file .github/required-assets.txt, else defaults
            let patterns = (process.env.SB_REQUIRED_ASSETS_PATTERNS || '').trim();
            if (!patterns) {
              try {
                const path = '.github/required-assets.txt';
                const { data: file } = await github.rest.repos.getContent({ owner, repo, path });
                const content = Buffer.from(file.content, file.encoding || 'base64').toString('utf8');
                patterns = content;
              } catch (e) {
                // defaults (glob-like regex): require at least one manual PDF and one appendix PDF
                patterns = ['.*manual.*_g[0-9a-f]{7,12}\\.pdf$', '.*appendix.*_g[0-9a-f]{7,12}\\.pdf$'].join('\n');
              }
            }
            const req = patterns.split(/\r?\n/).map(s => s.trim()).filter(Boolean).filter(s => !s.startsWith('#'));
            
            // 2) Get latest release + assets
            const rel = await github.rest.repos.getLatestRelease({ owner, repo }).catch(() => null);
            if (!rel || !rel.data) {
              core.setOutput('has_all','false');
              core.setOutput('missing','["<no release>"]');
              core.setOutput('tag_name', 'none');
              core.setOutput('workflow_status', 'none');
              return;
            }
            
            const assets = (rel.data.assets || []).map(a => a.name);
            const missing = [];
            for (const pat of req) {
              const re = new RegExp(pat, 'i');
              if (!assets.some(n => re.test(n))) missing.push(pat);
            }
            const ok = missing.length === 0;
            core.setOutput('has_all', ok ? 'true' : 'false');
            core.setOutput('missing', JSON.stringify(missing));
            core.setOutput('assetsListed', JSON.stringify(assets));
            core.setOutput('tag_name', rel.data.tag_name);
            core.setOutput('workflow_status', context.payload.workflow_run ? context.payload.workflow_run.conclusion : 'success');

      - name: Get latest release info
        id: latest
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              core.setOutput('tag', data.tag_name);
              core.setOutput('url', data.html_url);
            } catch (e) {
              core.setOutput('tag', '');
              core.setOutput('url', '');
            }

      - name: Write badge JSON
        env:
          SB_REQUIRED_ASSETS_PATTERNS: ${{ vars.SB_REQUIRED_ASSETS_PATTERNS }}
        run: |
          HAS_ALL="${{ steps.assets.outputs.has_all }}"
          MISSING="${{ steps.assets.outputs.missing }}"
          ASSETS="${{ steps.assets.outputs.assetsListed }}"
          TAG="${{ steps.assets.outputs.tag_name }}"
          STATUS="${{ steps.assets.outputs.workflow_status }}"
          
          mkdir -p .status
          
          if [ "$TAG" = "none" ]; then
            echo '{"schemaVersion":1,"label":"Docs Release","message":"no releases yet","color":"lightgrey","labelColor":"black"}' > .status/docs-release.json
            exit 0
          fi
          
          # Fold assets completeness into the result:
          if [ "$STATUS" = "success" ] && [ "$HAS_ALL" != "true" ]; then
            STATUS=incomplete
          fi
          
          case "$STATUS" in
            success)    COLOR="brightgreen"; MSG="${TAG} — passed";;
            incomplete) COLOR="yellow";      MSG="${TAG} — incomplete";;
            failure|cancelled|timed_out) COLOR="red"; MSG="${TAG} — failed";;
            *)          COLOR="yellow";      MSG="${TAG} — running";;
          esac
          
          URL="https://github.com/${{ github.repository }}/releases/latest"
          
          printf '{"schemaVersion":1,"label":"Docs Release","message":"%s","color":"%s","labelColor":"black","link":"%s"}\n' \
            "$MSG" "$COLOR" "$URL" > .status/docs-release.json

      - name: Write completeness badge JSON
        env:
          HAS_ALL: ${{ steps.assets.outputs.has_all }}
          MISSING: ${{ steps.assets.outputs.missing }}
          TAG: ${{ steps.latest.outputs.tag }}
          URL: ${{ steps.latest.outputs.url }}
        run: |
          if [ -z "$TAG" ]; then
            echo '{"schemaVersion":1,"label":"Docs Complete","message":"no release","color":"lightgrey","labelColor":"black"}' > .status/docs-release-completeness.json
          elif [ "$HAS_ALL" = "true" ]; then
            printf '{"schemaVersion":1,"label":"Docs Complete","message":"%s","color":"%s","labelColor":"black","link":"%s"}\n' \
              "complete" "brightgreen" "$URL" > .status/docs-release-completeness.json
          else
            n=$(python3 - <<'PY' "$MISSING"
import sys,json
try:
  m=json.loads(sys.argv[1]);
  print(len(m))
except Exception:
  print(0)
PY
            )
            msg="incomplete"; [ "$n" -gt 0 ] && msg="incomplete ($n)"
            printf '{"schemaVersion":1,"label":"Docs Complete","message":"%s","color":"%s","labelColor":"black","link":"%s"}\n' \
              "$msg" "yellow" "$URL" > .status/docs-release-completeness.json
          fi

      - name: Commit badge JSONs (status + completeness)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .status/docs-release.json .status/docs-release-completeness.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ci(badge): update docs-release status & completeness"
          git push
