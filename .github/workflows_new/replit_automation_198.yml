#!/usr/bin/env python3
"""
supersonic_super_bootstrap.py

One script to write the *entire* SonicBuilder support stack:
- GitHub deployer + Replit wrapper
- Makefile + vendor fetchers (PDF.js, JSZip)
- CI workflows: build + release
- MkDocs Material docs + docs workflow to gh-pages
- Live Artifacts & Releases panel (docs/devops/artifacts.md + JS)
- .env.example + badges snippet
- OWNER/REPO placeholders auto-filled from envs GITHUB_OWNER/GITHUB_REPO

Usage:
  export GITHUB_OWNER="YourUserOrOrg"
  export GITHUB_REPO="SonicBuilder"
  python3 supersonic_super_bootstrap.py

After:
  chmod +x replit_to_github.sh tools/get_pdfjs.sh tools/get_jszip.sh
  ./replit_to_github.sh
"""

import os, stat
from pathlib import Path

OWNER = os.getenv("GITHUB_OWNER", "OWNER")
REPO  = os.getenv("GITHUB_REPO", "REPO")
ROOT  = Path(__file__).resolve().parent

def _subst(s: str) -> str:
    return s.replace("OWNER", OWNER).replace("REPO", REPO)

def write(path: Path, content: str, exe: bool=False, do_subst: bool=True):
    path.parent.mkdir(parents=True, exist_ok=True)
    data = _subst(content) if do_subst else content
    path.write_text(data, encoding="utf-8")
    if exe:
        mode = path.stat().st_mode
        path.chmod(mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
    print(f"â†’ wrote {path}")

# ---------------- deploy_github.py ----------------
DEPLOY_GITHUB = r"""#!/usr/bin/env python3
import json, os, shutil, subprocess, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent

OWNER   = os.getenv("GITHUB_OWNER",   "your-username-or-org")
REPO    = os.getenv("GITHUB_REPO",    "SonicBuilder")
TOKEN   = os.getenv("GITHUB_TOKEN",   "")
AUTHOR  = os.getenv("GIT_AUTHOR_NAME","Supersonic Bot")
EMAIL   = os.getenv("GIT_AUTHOR_EMAIL","bot@example.com")
BRANCH  = os.getenv("GIT_DEFAULT_BRANCH","main")
MSG     = os.getenv("COMMIT_MSG","Supersonic: initial import")
PUSH_FORCE   = os.getenv("PUSH_FORCE","0") == "1"
ADD_LFS      = os.getenv("ADD_LFS","1") == "1"
ADD_WORKFLOW = os.getenv("ADD_WORKFLOW","1") == "1"
VISIBILITY   = os.getenv("VISIBILITY","private").lower().strip()

REMOTE_URL = f"https://github.com/{OWNER}/{REPO}.git"

LFS_PATTERNS = [
    "*.zip","*.7z","*.rar",
    "assets/audio/*.wav","assets/audio/*.mp3",
    "static/vendor/**",
    "docs/**/*.pdf","assets/**/*.pdf",
    "*.png","*.jpg","*.jpeg",
]

GITIGNORE = """__pycache__/
*.pyc
.env
.env.*
.venv/
venv/
dist/
build/
node_modules/
*.log
.DS_Store
.replit
replit.nix
.idea/
.vscode/
.cache/
*.cache/
pip-wheel-metadata/
*.zip
*.7z
*.tar
*.tar.gz
*.egg-info/
tmp/
local/
"""

WORKFLOW_YML = """name: Supersonic CI
on:
  push: { branches: [ main ] }
  pull_request:
jobs:
  sanity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install basics
        run: |
          python -m pip install --upgrade pip
          pip install flask
      - name: Smoke test app import
        run: |
          python - <<'PY'
          try:
              import app
              print("âœ… app.py import OK")
          except Exception as e:
              print("âŒ app.py import failed:", e)
              raise
          PY
"""

def run(cmd, check=True, capture=False):
    if capture:
        return subprocess.run(cmd, check=check, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True).stdout
    subprocess.run(cmd, check=check)

def have_cmd(bin_name: str) -> bool:
    return shutil.which(bin_name) is not None

def git(*args, check=True, capture=False):
    return run(["git", *args], check=check, capture=capture)

def ensure_git_repo():
    if not (ROOT / ".git").exists():
        print("â†’ Initializing git repo")
        git("init", "-b", BRANCH)
    else:
        try:
            git("rev-parse", "--verify", BRANCH)
        except subprocess.CalledProcessError:
            git("checkout", "-b", BRANCH)
        else:
            git("checkout", BRANCH)
    print("â†’ Setting author")
    git("config", "user.name", AUTHOR)
    git("config", "user.email", EMAIL)

def ensure_gitignore():
    gi = ROOT / ".gitignore"
    if not gi.exists():
        gi.write_text(GITIGNORE)
        print("â†’ Wrote .gitignore")

def ensure_lfs():
    if not ADD_LFS:
        print("â†’ Skipping Git LFS setup (ADD_LFS=0)")
        return
    if not have_cmd("git"):
        raise SystemExit("git not found in PATH")
    print("â†’ Ensuring Git LFS")
    if not have_cmd("git-lfs"):
        print("  ! git-lfs not found; skipping LFS (install it to use).")
        return
    run(["git", "lfs", "install"])
    gattr = ROOT / ".gitattributes"
    existing = gattr.read_text() if gattr.exists() else ""
    lines = existing.splitlines() if existing else []
    changed = False
    for pat in LFS_PATTERNS:
        rule = f"{pat} filter=lfs diff=lfs merge=lfs -text"
        if rule not in lines:
            lines.append(rule)
            changed = True
    if changed:
        gattr.write_text("\n".join(lines) + "\n")
        print(f"â†’ Updated .gitattributes with {len(LFS_PATTERNS)} LFS patterns")
    else:
        print("â†’ .gitattributes already contains LFS patterns")

def ensure_workflow():
    if not ADD_WORKFLOW:
        print("â†’ Skipping workflow (ADD_WORKFLOW=0)")
        return
    wf_dir = ROOT / ".github" / "workflows"
    wf_dir.mkdir(parents=True, exist_ok=True)
    wf = wf_dir / "supersonic-ci.yml"
    if not wf.exists():
        wf.write_text(WORKFLOW_YML)
        print("â†’ Added .github/workflows/supersonic-ci.yml")

def repo_exists_remote() -> bool:
    if have_cmd("gh"):
        try:
            run(["gh", "repo", "view", f"{OWNER}/{REPO}"], check=True, capture=True)
            return True
        except subprocess.CalledProcessError:
            return False
    if TOKEN:
        import urllib.request, urllib.error
        req = urllib.request.Request(
            f"https://api.github.com/repos/{OWNER}/{REPO}",
            headers={"Authorization": f"Bearer {TOKEN}",
                     "Accept":"application/vnd.github+json",
                     "X-GitHub-Api-Version":"2022-11-28"}
        )
        try:
            with urllib.request.urlopen(req) as resp:
                return resp.status == 200
        except urllib.error.HTTPError:
            return False
    return True

def create_repo_if_needed():
    if repo_exists_remote():
        print(f"â†’ Remote repo {OWNER}/{REPO} already exists")
        return
    print(f"â†’ Creating repo {OWNER}/{REPO} ({VISIBILITY})")
    if have_cmd("gh"):
        vis_flag = "--private" if VISIBILITY == "private" else "--public"
        run(["gh", "repo", "create", f"{OWNER}/{REPO}", vis_flag, "--confirm"])
        return
    if not TOKEN:
        raise SystemExit("No gh and no GITHUB_TOKEN set; cannot create repo automatically.")
    import urllib.request, json
    payload = {
        "name": REPO,
        "private": (VISIBILITY == "private"),
        "has_issues": True,
        "has_projects": False,
        "has_wiki": False,
        "auto_init": False,
    }
    api = "https://api.github.com/user/repos"
    req = urllib.request.Request(
        api,
        data=json.dumps(payload).encode("utf-8"),
        headers={"Authorization": f"Bearer {TOKEN}",
                 "Accept":"application/vnd.github+json",
                 "X-GitHub-Api-Version":"2022-11-28"}
    )
    with urllib.request.urlopen(req) as resp:
        if resp.status not in (200,201):
            raise SystemExit(f"GitHub API create repo failed: HTTP {resp.status}")
    print("â†’ Repo created via API")

def ensure_remote():
    remotes = git("remote", "-v", capture=True)
    if "origin" not in remotes:
        print(f"â†’ Adding remote origin {REMOTE_URL}")
        git("remote", "add", "origin", REMOTE_URL)
    else:
        print("â†’ Remote origin already set")

def commit_and_push():
    print("â†’ Adding files")
    git("add", "-A")
    has_commit = True
    try:
        git("rev-parse", "HEAD", capture=True)
    except subprocess.CalledProcessError:
        has_commit = False
    if has_commit:
        print(f"â†’ Committing: {MSG}")
        git("commit", "-m", MSG, check=False)
    else:
        print(f"â†’ First commit: {MSG}")
        git("commit", "-m", MSG)
    print("â†’ Pushing to GitHub")
    if PUSH_FORCE:
        git("push", "-u", "origin", BRANCH, "--force-with-lease")
    else:
        git("push", "-u", "origin", BRANCH)

def main():
    print("=== Supersonic GitHub Deploy ===")
    if OWNER == "your-username-or-org":
        print("! Set GITHUB_OWNER to your username/org.")
        sys.exit(1)
    ensure_git_repo()
    ensure_gitignore()
    ensure_lfs()
    ensure_workflow()
    create_repo_if_needed()
    ensure_remote()
    commit_and_push()
    print("\\nâœ… Done.")
    print(f"Repo: https://github.com/{OWNER}/{REPO}")
    print(f"Branch: {BRANCH}")
    print("\\nTips:")
    print(" - VISIBILITY=public (or private)")
    print(" - ADD_LFS=0 to skip LFS")
    print(" - ADD_WORKFLOW=0 to skip CI")
    print(" - PUSH_FORCE=1 for force-with-lease")
if __name__ == "__main__":
    main()
"""

# ---------------- replit_to_github.sh ----------------
REPLIT_TO_GH = r"""#!/usr/bin/env bash
set -euo pipefail

: "${GITHUB_OWNER:?Set GITHUB_OWNER to your GitHub username/org}"
: "${GITHUB_REPO:=SonicBuilder}"
: "${GIT_AUTHOR_NAME:=Christopher Elgin}"
: "${GIT_AUTHOR_EMAIL:=you@example.com}"
: "${VISIBILITY:=private}"
: "${ADD_LFS:=1}"
: "${ADD_WORKFLOW:=1}"
: "${PUSH_FORCE:=0}"

mkdir -p tools static/vendor/pdfjs static/vendor/jszip
if [[ ! -x tools/get_pdfjs.sh ]]; then
  cat > tools/get_pdfjs.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail
VER="4.6.82"
DEST="static/vendor/pdfjs"
mkdir -p "$DEST"
curl -sSL "https://unpkg.com/pdfjs-dist@${VER}/build/pdf.min.js"        -o "$DEST/pdf.min.js"
curl -sSL "https://unpkg.com/pdfjs-dist@${VER}/build/pdf.worker.min.js" -o "$DEST/pdf.worker.min.js"
echo "PDF.js ${VER} vendored into ${DEST}/"
SH
  chmod +x tools/get_pdfjs.sh
fi

if [[ ! -x tools/get_jszip.sh ]]; then
  cat > tools/get_jszip.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail
VER="3.10.1"
DEST="static/vendor/jszip"
mkdir -p "$DEST"
curl -sSL "https://unpkg.com/jszip@${VER}/dist/jszip.min.js" -o "$DEST/jszip.min.js"
echo "JSZip ${VER} vendored into ${DEST}/"
SH
  chmod +x tools/get_jszip.sh
fi

./tools/get_pdfjs.sh
./tools/get_jszip.sh

python3 deploy_github.py
"""

# ---------------- Makefile ----------------
MAKEFILE = r"""# SonicBuilder shortcuts
.PHONY: vendor run test push clean docs-serve docs-build

vendor:
	@chmod +x tools/get_pdfjs.sh tools/get_jszip.sh || true
	@./tools/get_pdfjs.sh
	@./tools/get_jszip.sh

run:
	@FLASK_ENV=development CATALOG_TTL_HOURS=0.17 flask run

test:
	@python - <<'PY'
try:
	import app
	print("âœ… app.py import OK")
except Exception as e:
	print("âŒ app.py import failed:", e); raise
PY

push:
	@python3 deploy_github.py

docs-serve:
	@python -m pip install -r requirements.docs.txt >/dev/null
	@mkdocs serve

docs-build:
	@python -m pip install -r requirements.docs.txt >/dev/null
	@mkdocs build --clean

clean:
	@rm -rf dist build .cache tmp site || true
"""

# ---------------- CI Workflow (build artifacts) ----------------
CI_YML = r"""name: Supersonic CI
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install flask

      - name: Vendor frontend libs (PDF.js / JSZip)
        run: |
          chmod +x tools/get_pdfjs.sh tools/get_jszip.sh
          ./tools/get_pdfjs.sh
          ./tools/get_jszip.sh

      - name: Smoke test import
        run: |
          python - <<'PY'
          try:
            import app
            print("âœ… app.py import OK")
          except Exception as e:
            print("âŒ app.py import failed:", e)
            raise
          PY

      - name: Upload vendored assets
        uses: actions/upload-artifact@v4
        with:
          name: static-vendor
          path: |
            static/vendor/pdfjs/*
            static/vendor/jszip/*

      - name: Upload docs (PDFs if any)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: docs-pdfs
          path: |
            docs/**/*.pdf
          if-no-files-found: ignore
"""

# ---------------- Release Workflow ----------------
RELEASE_YML = r"""name: Supersonic Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Prepare vendor libs
        run: |
          chmod +x tools/get_pdfjs.sh tools/get_jszip.sh || true
          ./tools/get_pdfjs.sh || true
          ./tools/get_jszip.sh || true

      - name: Build release zip
        run: |
          mkdir -p dist
          zip -r dist/REPO_${{ github.ref_name }}.zip . \
            -x "*.git*" ".github/*" "dist/*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: REPO ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            dist/REPO_${{ github.ref_name }}.zip
"""

# ---------------- MkDocs Config & Docs ----------------
MKDOCS_YML = r"""site_name: REPO
site_description: Android head unit project â€¢ DSP configs â€¢ wiring PDFs â€¢ packaging
site_url: https://OWNER.github.io/REPO/
repo_url: https://github.com/OWNER/REPO
repo_name: OWNER/REPO
copyright: Â© REPO

theme:
  name: material
  features:
    - navigation.instant
    - navigation.sections
    - navigation.expand
    - navigation.top
    - search.highlight
    - search.suggest
    - content.code.copy
    - content.tabs.link
  palette:
    - media: "(prefers-color-scheme: dark)"
      scheme: slate
      primary: cyan
      accent: cyan
    - media: "(prefers-color-scheme: light)"
      scheme: default
      primary: cyan
      accent: cyan
  icon:
    repo: fontawesome/brands/github

extra:
  social:
    - icon: fontawesome/brands/github
      link: https://github.com/OWNER
  generator: false

plugins:
  - search
  - minify:
      minify_html: true
  - git-revision-date-localized:
      enable_creation_date: true
      fallback_to_build_date: true
  - glightbox
  - section-index

markdown_extensions:
  - admonition
  - pymdownx.details
  - pymdownx.superfences
  - pymdownx.inlinehilite
  - pymdownx.highlight
  - pymdownx.extra
  - pymdownx.tilde
  - toc:
      permalink: true

extra_javascript:
  - docs/assets/js/config.js
  - docs/assets/js/artifacts.js

nav:
  - Overview: index.md
  - Quickstart:
      - Setup: quickstart.md
      - Build & Run: build-run.md
  - Diagrams:
      - Using the Picker: diagrams/picker.md
      - Export Options: diagrams/export.md
  - DevOps:
      - GitHub Actions: devops/ci.md
      - Releases: devops/releases.md
      - Live Artifacts: devops/artifacts.md
  - About: about.md
"""

INDEX_MD = r"""# âš¡ REPO

Welcome to the **Supersonic** docs.

!!! tip "What is this?"
    A complete build system for Android head units:
    DSP configs, wiring PDFs, packaging, and a slick diagram picker with PNG/PDF/ZIP export.

## Highlights

- ðŸŽšï¸ DSP configs + wiring PDFs  
- ðŸ§© Diagram picker with **ZIP/PNG/PDF** export  
- â±ï¸ Env-aware **catalog cache** (TTL + version)  
- ðŸŒ™ Material theme with dark/light & search  
- ðŸš€ CI (build, artifacts, release zip on tag)  

## Useful Links

- **Repository:** [OWNER/REPO](https://github.com/OWNER/REPO)
- **CI Artifacts:** GitHub â†’ Actions â†’ latest run â†’ *Artifacts*
- **Releases:** GitHub â†’ Releases (push a tag like `v1.0.0`)
"""

QUICKSTART_MD = r"""# Quickstart

## Requirements
- Python 3.11+
- (Optional) `gh` GitHub CLI
- Git

## Steps

```bash
make vendor     # pulls PDF.js and JSZip
make run        # dev server (fast cache; ~10m TTL)