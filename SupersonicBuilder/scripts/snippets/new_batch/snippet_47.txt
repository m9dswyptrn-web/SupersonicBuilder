#!/usr/bin/env python3
import argparse, re, html, datetime
from pathlib import Path

CSS = r"""
:root {
  --bg: #0b0d10;
  --panel: #12151a;
  --ink: #e7eaf1;
  --muted: #a9b2c0;
  --accent: #00d1d1; /* cyan */
  --accent2: #ffc857; /* amber */
  --border: #1c222a;
  --code-bg: #0f1115;
}
/* Light theme vars */
:root[data-theme="light"] {
  --bg: #fafafa;
  --panel: #ffffff;
  --ink: #121212;
  --muted: #2e3440;
  --accent: #006d6d;
  --accent2: #b88000;
  --border: #e6e6e6;
  --code-bg: #f5f7fb;
}
* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--ink);
  font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.5;
}
header {
  position: sticky; top: 0; z-index: 10;
  background: var(--panel); color: var(--ink);
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
header strong { letter-spacing: 0.3px; }
.badge {
  display: inline-block; margin-left: 8px;
  background: rgba(0, 209, 209, 0.12); color: var(--accent);
  padding: 2px 8px; border: 1px solid rgba(0, 209, 209, 0.35);
  border-radius: 12px; font-size: 12px;
}
:root[data-theme="light"] .badge {
  background: rgba(0, 109, 109, 0.08); border-color: rgba(0, 109, 109, 0.25);
}
.spacer { flex: 1 1 auto; }
.action {
  display: inline-flex; align-items: center; gap: 8px;
  font-size: 12px; color: var(--muted); cursor: pointer; user-select: none;
  border: 1px solid var(--border); padding: 6px 10px; border-radius: 16px;
}
.count-badge {
  display: inline-block; margin-left: 8px; padding: 2px 8px;
  border-radius: 10px; font-size: 12px; line-height: 1;
  background: rgba(255, 200, 87, 0.15); color: var(--accent2);
  border: 1px solid rgba(255, 200, 87, 0.35);
}
main { max-width: 980px; margin: 24px auto; padding: 0 16px; }
h1, h2, h3 { color: var(--ink); }
h1 { border-left: 4px solid var(--accent); padding-left: 10px; }
h2 { margin-top: 24px; border-left: 3px solid var(--accent2); padding-left: 10px; }
p { color: var(--muted); }
ul { padding-left: 22px; }
li { margin: 4px 0; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }
code, pre { background: var(--code-bg); color: var(--ink);
  padding: 0.2em 0.4em; border-radius: 4px; border: 1px solid var(--border); }
pre { padding: 12px; overflow: auto; }
hr { border: 0; border-top: 1px solid var(--border); margin: 24px 0; }
.footer {
  color: var(--muted); border-top: 1px solid var(--border);
  margin-top: 32px; padding-top: 12px; font-size: 12px;
}

/* TOC box */
.toc {
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: 8px;
  padding: 12px 14px;
  margin: 0 0 16px 0;
}
.toc h3 { margin: 0 0 8px 0; font-size: 14px; color: var(--ink); }
.toc a { margin-right: 12px; }
.toc .toc-count { opacity: 0.9; font-weight: 600; margin-left: 2px; }

/* Optional page-break mode (toggled) */
body.page-breaks h2 { break-before: page; page-break-before: always; }
body.page-breaks h2:first-of-type { break-before: auto; page-break-before: auto; }

/* Printed/PDF layout */
@page { margin: 12mm 12mm 16mm 12mm; }
@media print {
  :root, :root[data-theme="light"] {
    --bg: #ffffff !important; --panel: #ffffff !important;
    --ink: #000000 !important; --muted: #000000 !important;
    --accent: #000000 !important; --accent2: #000000 !important;
    --border: #000000 !important; --code-bg: #f2f2f2 !important;
  }
  body { background: #ffffff !important; color: #000 !important; }
  header, .footer { display: none !important; }
  a { color: #000 !important; text-decoration: underline !important; }
  code, pre { background: #f2f2f2 !important; color: #000 !important; border: 1px solid #999 !important; }
  h1 { border-left: 4px solid #000 !important; }
  h2 { border-left: 3px solid #000 !important; }

  /* Fixed footer (with page numbers) */
  .print-footer {
    position: fixed; bottom: 0; left: 0; right: 0;
    font-size: 10px; color: #000; padding: 6px 0 0 0;
    border-top: 1px solid #999; text-align: center;
  }
  .print-footer::after {
    content: " • Page " counter(page) " of " counter(pages);
  }
}
"""

SCRIPT = r"""
(function(){
  const root = document.documentElement;
  const themeKey  = 'sb-diff-theme';
  const breaksKey = 'sb-diff-breaks';

  function currentMode(){ return (root.getAttribute('data-theme') === 'light') ? 'light' : 'dark'; }
  function applyTheme(mode){
    if(mode==='light'){ root.setAttribute('data-theme','light'); }
    else { root.removeAttribute('data-theme'); }
    try { localStorage.setItem(themeKey, mode); } catch(e){}
    const lab = document.getElementById('sb-toggle-label');
    if (lab) lab.textContent = (mode==='light') ? 'Light' : 'Dark';
  }
  function applyBreaks(enabled){
    if (enabled) root.classList.add('page-breaks');
    else root.classList.remove('page-breaks');
    try { localStorage.setItem(breaksKey, enabled ? '1':'0'); } catch(e){}
    const lab = document.getElementById('sb-breaks-label');
    if (lab) lab.textContent = enabled ? 'On' : 'Off';
  }

  // Theme init
  let mode = 'dark';
  try {
    const saved = localStorage.getItem(themeKey);
    if(saved==='light' || saved==='dark') mode = saved;
    else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) mode = 'light';
  } catch(e){}
  applyTheme(mode);

  // Breaks init
  let breaks = false;
  try { breaks = (localStorage.getItem(breaksKey) === '1'); } catch(e){}
  applyBreaks(breaks);

  // Toggle theme
  const tgl = document.getElementById('sb-toggle');
  if (tgl) tgl.addEventListener('click', function(){
    mode = (currentMode()==='light') ? 'dark' : 'light';
    applyTheme(mode);
  });

  // Toggle page breaks
  const brk = document.getElementById('sb-breaks');
  if (brk) brk.addEventListener('click', function(){
    breaks = !breaks;
    applyBreaks(breaks);
  });

  // Print (paper)
  const prn = document.getElementById('sb-print');
  if (prn) prn.addEventListener('click', function(){
    const before = currentMode();
    applyTheme('light');
    const restore = function(){ applyTheme(before); window.removeEventListener('afterprint', restore); };
    window.addEventListener('afterprint', restore, { once: true });
    setTimeout(() => window.print(), 20);
  });

  // Export PDF (print-to-PDF + refreshed footer timestamp)
  const pdf = document.getElementById('sb-export');
  if (pdf) pdf.addEventListener('click', function(){
    const before = currentMode();
    applyTheme('light');
    const pf = document.getElementById('sb-print-footer');
    if (pf) {
      const now = new Date();
      const iso = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0')+"-"+String(now.getDate()).padStart(2,'0')
                 +" "+String(now.getHours()).padStart(2,'0')+":"+String(now.getMinutes()).padStart(2,'0');
      pf.setAttribute('data-ts', iso);
      pf.textContent = pf.getAttribute('data-prefix') + " • " + pf.getAttribute('data-version') + " • " + iso;
    }
    const restore = function(){ applyTheme(before); window.removeEventListener('afterprint', restore); };
    window.addEventListener('afterprint', restore, { once: true });
    setTimeout(() => window.print(), 20);
  });
})();
"""

def parse_heads_and_counts(md: str):
  """
  Parse headings and count list items under Added/Removed/Changed sections.
  Returns:
    heads: [(level, title, anchor)]
    counts_by_anchor: {anchor: int}
  """
  heads = []
  counts = {}
  current_h2_anchor = None
  current_h2_title  = None
  target_titles = {"added", "removed", "changed"}

  for line in md.splitlines():
    if line.startswith("# "):
      title = line[2:].strip()
      anchor = re.sub(r'[^a-z0-9\-]+', '-', title.lower())
      heads.append((1, title, anchor))
      current_h2_anchor = None
      current_h2_title  = None

    elif line.startswith("## "):
      title = line[3:].strip()
      anchor = re.sub(r'[^a-z0-9\-]+', '-', title.lower())
      heads.append((2, title, anchor))
      # Track if this H2 is one of our target sections
      if title.lower() in target_titles:
        current_h2_anchor = anchor
        current_h2_title  = title.lower()
        counts.setdefault(anchor, 0)
      else:
        current_h2_anchor = None
        current_h2_title  = None

    elif line.startswith("- "):
      # List item: increment if currently inside a target H2
      if current_h2_anchor:
        counts[current_h2_anchor] = counts.get(current_h2_anchor, 0) + 1

    elif line.strip() == "":
      # ignore
      pass
    else:
      # Any other content; no change
      pass

  return heads, counts

def build_toc(heads, counts_by_anchor):
  """Compact TOC with counts for Added/Removed/Changed when present."""
  h2_map = {t.lower(): (t, a) for _, t, a in heads if _ == 2}
  items = []
  for key in ("Added", "Removed", "Changed"):
    k = key.lower()
    if k in h2_map:
      t, a = h2_map[k]
      c = counts_by_anchor.get(a)
      if c is not None:
        items.append((t, a, c))
      else:
        items.append((t, a, None))

  if not items:
    # fallback: first up to 3 H2s without counts
    h2s = [(t, a) for lvl, t, a in heads if lvl == 2][:3]
    if not h2s:
      return ""
    links = " ".join(f'<a href="#{html.escape(a)}">{html.escape(t)}</a>' for t,a in h2s)
    return f'<div class="toc"><h3>Contents</h3>{links}</div>'

  parts = []
  for t, a, c in items:
    label = html.escape(t)
    if c is not None:
      label += f' <span class="toc-count">({c})</span>'
    parts.append(f'<a href="#{html.escape(a)}">{label}</a>')
  return f'<div class="toc"><h3>Contents</h3>{" ".join(parts)}</div>'

def md_to_html_with_ids(md: str, counts_by_anchor):
  lines = md.splitlines()
  out = []
  in_list = False
  for ln in lines:
    if ln.startswith("# "):
      if in_list: out.append("</ul>"); in_list=False
      title = ln[2:].strip()
      out.append(f"<h1>{html.escape(title)}</h1>")

    elif ln.startswith("## "):
      if in_list: out.append("</ul>"); in_list=False
      title = ln[3:].strip()
      anchor = re.sub(r'[^a-z0-9\-]+', '-', title.lower())
      count_html = ""
      if anchor in counts_by_anchor:
        count_html = f' <span class="count-badge">{counts_by_anchor[anchor]}</span>'
      out.append(f'<h2 id="{anchor}">{html.escape(title)}{count_html}</h2>')

    elif ln.startswith("- "):
      if not in_list:
        out.append("<ul>"); in_list=True
      out.append(f"<li>{html.escape(ln[2:].strip())}</li>")

    elif ln.startswith("> "):
      if in_list: out.append("</ul>"); in_list=False
      out.append(f'<blockquote>{html.escape(ln[2:].strip())}</blockquote>')

    elif ln.strip() == "":
      if in_list: out.append("</ul>"); in_list=False
      out.append("<br/>")

    else:
      if in_list: out.append("</ul>"); in_list=False
      out.append(f"<p>{html.escape(ln)}</p>")

  if in_list: out.append("</ul>")
  return "\n".join(out)

def guess_version(md_stem: str) -> str:
  m = re.search(r'v(\d+(?:\.\d+){0,3})', md_stem, re.I)
  return m.group(0) if m else md_stem

def main():
  ap = argparse.ArgumentParser()
  ap.add_argument("--md", required=True)
  ap.add_argument("--out", default="")
  args = ap.parse_args()

  md_path = Path(args.md)
  if not md_path.exists():
    raise SystemExit(f"[x] Markdown file not found: {md_path}")
  html_path = Path(args.out) if args.out else md_path.with_suffix(".html")

  md = md_path.read_text(encoding="utf-8")
  heads, counts = parse_heads_and_counts(md)
  toc_html = build_toc(heads, counts)
  body = md_to_html_with_ids(md, counts)

  title = "Pre-publish Diff - " + md_path.stem
  version = guess_version(md_path.stem)
  today = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")

  doc = f"""<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{title}</title>
<style>{CSS}</style>
<body>
<header>
  <strong>Pre-publish Diff</strong>
  <span class="badge">{html.escape(md_path.stem)}</span>
  <span class="spacer"></span>
  <span class="action" id="sb-toggle">Theme: <b id="sb-toggle-label"></b></span>
  <span class="action" id="sb-breaks">Page Breaks: <b id="sb-breaks-label"></b></span>
  <span class="action" id="sb-print">Print</span>
  <span class="action" id="sb-export">Export PDF</span>
</header>
<main>
{toc_html}
{body}
<div class="footer">Generated by SonicBuilder diff renderer</div>
</main>

<!-- Print/PDF footer (fixed at bottom of page) -->
<div class="print-footer" id="sb-print-footer"
     data-prefix="SonicBuilder Diff"
     data-version="{html.escape(version)}"
     data-ts="{html.escape(today)}">
  SonicBuilder Diff • {html.escape(version)} • {html.escape(today)}
</div>

<script>{SCRIPT}</script>
</body></html>
"""
  html_path.write_text(doc, encoding="utf-8")
  print(str(html_path))

if __name__ == "__main__":
  main()