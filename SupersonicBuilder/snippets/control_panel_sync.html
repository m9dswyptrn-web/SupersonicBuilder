<!-- snippets/control_panel_sync.html -->
<section id="sync-panel" style="border:1px solid #223; border-radius:10px; padding:14px; background:#0b0f14; color:#e6eef8; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial;">
  <header style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
    <h3 style="margin:0;">ðŸ”„ Repo Sync</h3>
    <span id="sync-status-chip" style="font-size:12px; padding:2px 8px; border-radius:999px; background:#1b2635; border:1px solid #203044;">checkingâ€¦</span>
    <span id="sync-last" style="font-size:12px; opacity:.8;"></span>
  </header>
  <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
    <button id="syncNowBtn" style="cursor:pointer; padding:10px 16px; border-radius:8px; border:1px solid #3a556f; background:#163148; color:#e6eef8; font-weight:600;">Run Sync Now</button>
    <span id="sync-cooldown" style="font-size:13px; opacity:.9;">â€¦</span>
  </div>
  <details id="sync-log-wrap" style="margin-top:12px;">
    <summary style="cursor:pointer;">Show last run log</summary>
    <pre id="sync-log" style="background:#0f1720; border:1px solid #223; border-radius:8px; padding:10px; max-height:260px; overflow:auto; white-space:pre-wrap;"></pre>
  </details>
</section>
<script>
(function(){
  const btn = document.getElementById('syncNowBtn');
  const chip = document.getElementById('sync-status-chip');
  const cd = document.getElementById('sync-cooldown');
  const last = document.getElementById('sync-last');
  const logWrap = document.getElementById('sync-log-wrap');
  const logEl = document.getElementById('sync-log');

  const successAudio = new Audio('/assets/audio/notify_success.wav');
  const errorAudio = new Audio('/assets/audio/notify_error.wav');

  const fmt = (s)=> new Date(s).toLocaleString();
  const setChip = (txt, color) => { chip.textContent = txt; chip.style.background = color.bg; chip.style.borderColor = color.bd; };
  const COLORS = { running:{bg:'#2a3f25',bd:'#355a2e'}, ready:{bg:'#1b2635',bd:'#203044'}, wait:{bg:'#3a2e1b',bd:'#5a4a2e'}, error:{bg:'#3a1b1b',bd:'#5a2e2e'} };

  async function fetchStatus() {
    try {
      const r = await fetch('/api/ping', {cache:'no-store'});
      const s = await r.json();
      const running = false; // ping doesn't expose running; minimal UI
      const next = 0;
      if (running) { setChip('runningâ€¦', COLORS.running); btn.disabled = true; cd.textContent = 'Sync runningâ€¦'; }
      else if (next > 0) { setChip('cooldown', COLORS.wait); btn.disabled = true; cd.textContent = `Ready in ${next}s`; }
      else { setChip('ready', COLORS.ready); btn.disabled = false; cd.textContent = 'Ready'; }
      last.textContent = s.sync.last_finished ? `last run: ${fmt(s.sync.last_finished)}` : '';
    } catch (e) {
      setChip('status error', COLORS.error); cd.textContent = 'Unable to reach /api/ping'; btn.disabled = false;
    }
  }

  async function runSync() {
    btn.disabled = true; setChip('startingâ€¦', COLORS.running); cd.textContent = 'Sync runningâ€¦';
    try {
      const r = await fetch('/api/sync', { method: 'POST' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      logEl.textContent = (j.message || 'queued');
      if (!logWrap.open) logWrap.open = true;
      setTimeout(fetchStatus, 3500);
    } catch (e) {
      errorAudio.play().catch(()=>{});
      logEl.textContent = 'Request error: ' + e;
      setChip('error', COLORS.error);
    } finally {
      btn.disabled = false;
    }
  }

  btn.addEventListener('click', runSync);
  fetchStatus(); setInterval(fetchStatus, 5000);
})();
</script>
