name: üîß System Health CI/CD Pipeline

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

env:
  PAGES_BRANCH: gh-pages
  REMOTE_NAME: origin
  PYTHONUNBUFFERED: 1

jobs:
  system-health:
    name: Update System Health Status
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # =============================================================
      # üìä Generate System Health Summary
      # =============================================================
      
      - name: üìä Generate System Health Summary
        run: |
          echo "üîç Generating system health summary..."
          python3 scripts/gen_system_json.py
      
      # =============================================================
      # üöÄ Push System Health to GitHub Pages
      # =============================================================
      
      - name: üöÄ Push System Health Summary to Pages
        if: success()
        run: |
          echo "üì§ Pushing system.json to GitHub Pages..."
          python3 scripts/push_system_json.py
      
      # =============================================================
      # üîÑ Rollback Protection on Failure
      # =============================================================
      
      - name: üîÑ Rollback System Health if Corrupted
        if: failure() || cancelled()
        run: |
          echo "üîç Checking for corruption or failed commit‚Ä¶"
          python3 scripts/rollback_system_json.py
      
      # =============================================================
      # üîî Discord/Slack Notifications
      # =============================================================
      
      - name: üü¢ Notify Successful Deploy
        if: success()
        env:
          ROLLBACK_WEBHOOK_URL: ${{ secrets.ROLLBACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ROLLBACK_EVENT: "system_json_push"
          ROLLBACK_STATUS: "success"
        run: |
          echo "üü¢ Sending success notification..."
          python3 scripts/notify_rollback.py
      
      - name: üî¥ Notify Rollback or Failure
        if: failure() || cancelled()
        env:
          ROLLBACK_WEBHOOK_URL: ${{ secrets.ROLLBACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ROLLBACK_EVENT: "system_json_push"
          ROLLBACK_STATUS: "rollback"
        run: |
          echo "üî¥ Sending rollback notification..."
          python3 scripts/notify_rollback.py
      
      # =============================================================
      # ‚úÖ Verify Health & Refresh Badges
      # =============================================================
      
      - name: ‚úÖ Verify Health and Badges
        if: success()
        run: |
          echo "üß© Verifying integrity of system.json..."
          sha256sum docs/status/system.json
          echo "‚úÖ Badge, JSON feed, and PDF status refreshed."
      
      # =============================================================
      # üì¶ Artifact Archival (Success)
      # =============================================================
      
      - name: üì¶ Upload SonicBuilder Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SonicBuilder-${{ github.run_number }}-${{ github.sha }}
          path: |
            docs/**/*.pdf
            docs/status/system.json
            docs/status/uptime_log.json
            docs/status/heartbeat.json
            badges/*.json
          retention-days: 30
      
      # =============================================================
      # üì¶ Artifact Archival (Failure)
      # =============================================================
      
      - name: üì¶ Upload Failure Logs
        if: failure() || cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: SonicBuilder-Failure-${{ github.run_number }}-${{ github.sha }}
          path: |
            docs/status/*.json
            .github/workflows/**/*.yml
            scripts/**/*.py
          retention-days: 14
      
      # =============================================================
      # ü©∫ Final Health Check
      # =============================================================
      
      - name: ü©∫ Verify PDF and System Health
        if: success()
        run: |
          echo "üîç Checking PDF integrity and build logs..."
          ls -lh docs/*.pdf 2>/dev/null || echo "‚ö†Ô∏è No PDFs found in docs/"
          ls -lh docs_build/*.pdf 2>/dev/null || echo "‚ö†Ô∏è No PDFs found in docs_build/"
          ls -lh docs/status/system.json || echo "‚ö†Ô∏è No system.json found."
          echo "‚úÖ Health verification complete."
