name: pr-docs-ready-label
on:
  workflow_run:
    workflows: ["docs-build"]
    types: [completed]
permissions:
  contents: read
  actions: read
  pull-requests: write
  issues: write

jobs:
  label:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Add/ensure docs:ready label on PR
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const { owner, repo } = context.repo;

            // Find PR(s) by head SHA
            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:pr sha:${run.head_sha}`
            });
            if (!search.data.items.length) {
              core.info('No PR found for this run/sha.');
              return;
            }

            // Ensure label exists
            const labelName = 'docs:ready';
            async function ensureLabel() {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch {
                await github.rest.issues.createLabel({
                  owner, repo, name: labelName,
                  color: '0e8a16',
                  description: 'Docs build passed for this PR'
                });
              }
            }
            await ensureLabel();

            // Apply label to all matching PRs
            for (const pr of search.data.items) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: pr.number, labels: [labelName]
              });
            }
