name: Prepare & Publish (Supersonic ControlCore v3)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish (defaults to ref name on tag push)"
        required: false
      name:
        description: "Release title (defaults to tag)"
        required: false
      draft:
        description: "Create as draft?"
        default: "false"
        required: false
      prerelease:
        description: "Mark as prerelease?"
        default: "false"
        required: false
      body_file:
        description: "Path to release body markdown"
        default: "docs/Supersonic_Overlays_MEGA_v2_ReleaseBody.md"
        required: false

permissions:
  contents: write

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests semver watchdog colorama rich pyttsx3 playsound

      - name: Smart bump (v3)
        env:
          SUP_AUTOPUSH: "1"
        run: |
          python3 scripts/version_bump.py

      - name: Build with Control Core (AI summary enabled)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUP_ENGINE_MODE: hybrid
          QUIET: "1"
        run: |
          python3 helpers/supersonic_core.py build --ai || true

      - name: Resolve tag and URLs
        id: meta
        shell: bash
        run: |
          TAG="$(git describe --tags --abbrev=0)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          REPO="${{ github.repository }}"
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "release_url=https://github.com/$REPO/releases/tag/$TAG" >> $GITHUB_OUTPUT
          echo "pages_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$TAG/" >> $GITHUB_OUTPUT

      - name: Inject Pages badge into README
        shell: bash
        run: |
          FILE="docs/README_ControlCore.md"
          if [ -f "$FILE" ]; then
            sed -i "s#(\\./)#(${{ steps.meta.outputs.pages_url }})#g" "$FILE" || true
            git add "$FILE" && git commit -m "docs: update Pages badge for ${{ steps.meta.outputs.tag }}" || true
            git push || true
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: supersonic-mega-zip
          path: SonicBuilder_Supersonic_Overlays_MEGA_v2.zip
          if-no-files-found: ignore

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG='${{ steps.meta.outputs.tag }}'
          NAME="${TAG} (Supersonic)"
          BODY_FILE="docs/Supersonic_Overlays_MEGA_v2_ReleaseBody.md"
          [ -f "$BODY_FILE" ] || BODY_FILE="docs/README_ControlCore.md"
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "$NAME" --notes-file "$BODY_FILE" || true
          else
            gh release edit "$TAG" --title "$NAME" --notes-file "$BODY_FILE" || true
          fi
          if [ -f "SonicBuilder_Supersonic_Overlays_MEGA_v2.zip" ]; then
            gh release upload "$TAG" "SonicBuilder_Supersonic_Overlays_MEGA_v2.zip" --clobber || true
          fi

      - name: Notify webhooks
        env:
          SUP_DISCORD_WEBHOOK: ${{ secrets.SUP_DISCORD_WEBHOOK }}
          SUP_SLACK_WEBHOOK: ${{ secrets.SUP_SLACK_WEBHOOK }}
        run: |
          python3 scripts/notify_webhooks.py --asset "SonicBuilder_Supersonic_Overlays_MEGA_v2.zip"
