name: Pages • Build & Publish Latest PDF

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'build/**/*.pdf'
      - 'dist/**/*.pdf'
      - '.github/workflows/pages-publish.yml'
  release:
    types: [published, edited]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-publish
  cancel-in-progress: true

env:
  BUILD_CMD: ":"                  # change to 'make docs' if CI builds PDFs
  PDF_GLOB_PRIMARY: build/**/*.pdf
  PDF_GLOB_FALLBACK: dist/**/*.pdf
  OUTDIR: __site

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: (Optional) Build PDFs in CI
        run: $BUILD_CMD

      - name: Find newest PDF
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          PDFs=(${{ env.PDF_GLOB_PRIMARY }})
          if [ ${#PDFs[@]} -eq 0 ]; then
            PDFs=(${{ env.PDF_GLOB_FALLBACK }})
          fi
          if [ ${#PDFs[@]} -eq 0 ]; then
            echo "No PDFs found." >&2
            exit 1
          fi
          newest=$(ls -t "${PDFs[@]}" | head -n1)
          echo "newest=$newest" >> $GITHUB_OUTPUT
          echo "Picked: $newest"

      - name: Stage Pages site
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "${OUTDIR}"
          mkdir -p "${OUTDIR}/downloads"
          touch "${OUTDIR}/.nojekyll"
          cp "${{ steps.pick.outputs.newest }}" "${OUTDIR}/downloads/"
          newest_name=$(basename "${{ steps.pick.outputs.newest }}")
          # Make/update latest.pdf (symlink if possible, else copy)
          ln -sfn "${newest_name}" "${OUTDIR}/downloads/latest.pdf" 2>/dev/null \
            || cp -f "${OUTDIR}/downloads/${newest_name}" "${OUTDIR}/downloads/latest.pdf"
          # Minimal front page
          cat > "${OUTDIR}/index.html" <<'HTML'
          <!doctype html><meta charset="utf-8">
          <title>SonicBuilder Downloads</title>
          <style>html{color-scheme:dark light}body{font:16px/1.5 system-ui;margin:40px;max-width:880px}a.btn{display:inline-block;padding:.6rem 1rem;border:1px solid #3a6df0;border-radius:8px;text-decoration:none}</style>
          <h1>SonicBuilder — Downloads</h1>
          <p><a class="btn" href="./downloads/latest.pdf">⬇️ Download latest.pdf</a></p>
          <p>All PDFs are in <code>/downloads/</code>.</p>
          HTML

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.OUTDIR }}

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "### ✅ Pages deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Site: ${{ steps.deploy.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- Latest PDF: ${{ steps.deploy.outputs.page_url }}downloads/latest.pdf" >> $GITHUB_STEP_SUMMARY
