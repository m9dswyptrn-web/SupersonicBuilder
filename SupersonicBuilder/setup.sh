#!/usr/bin/env bash
set -euo pipefail; mkdir -p tools docs/status build; if [[ ! -f VERSION ]]; then last_tag="\$(git tag --list 'v*' | sort -V | tail -n1 || true)"; if [[ -n "\${last_tag}" ]]; then echo "\${last_tag#v}" > VERSION; else echo "2.1.1" > VERSION; fi; fi; cat > tools/bump_version.sh <<\'EOT\'\n#!/usr/bin/env bash\nset -euo pipefail\nfile="VERSION"\n[[ -f "\$file" ]] || { echo "VERSION file missing"; exit 1; }\nver="\$(cat "\$file")"\nIFS=\'.\' read -r MAJ MIN PAT <<<\$ver\n: "\${MAJ:=0}" "\${MIN:=0}" "\${PAT:=0}"\n((PAT=PAT+1))\nnew="\${MAJ}.\${MIN}.\${PAT}"\necho "\$new" > "\$file"\necho "Bumped version: \${ver} -> \${new}"\nEOT\nchmod +x tools/bump_version.sh; cat > tools/make_release_manifest.sh <<\'EOT\'\n#!/usr/bin/env bash\nset -euo pipefail\n\n# Inputs / defaults\nVERSION="\$(cat VERSION)"\nTAG="v\${VERSION}"\nOUT_DIR="docs/status"\nZIP_GLOB="build/Supersonic_Control_And_Health_Pack_v\${VERSION}.zip"\nPDF_GLOB="docs/installer/*.pdf"\n\nmkdir -p "\${OUT_DIR}"\n\n# Git info\ncommit="\$(git rev-parse --short=12 HEAD)"\nbranch="\$(git rev-parse --abbrev-ref HEAD)"\nrepo_url="\$(git config --get remote.origin.url || echo '')"\nutc_now="\$(date -u +\'%Y-%m-%dT%H:%M:%SZ\')"\n\n# Hash helper (prints size bytes + sha256 for a file if it exists)\nhash_one () {\n  local f="\$1"\n  [[ -f "\$f" ]] || return 0\n  local sz sha\n  sz="\$(wc -c < "\$f" | tr -d \' \')"\n  sha="\$(sha256sum "\$f" | awk \'{print \$1}\')"\n  printf \'  {"path":"%s","bytes":%s,"sha256":"%s"}\' "\$f" "\$sz" "\$sha"\n}\n\n# Collect artifacts (zip + PDFs)\nartifacts="[]"\n\n# ZIP (preferred bundle name; fall back to any matching build zip)\nzip_candidates=()\nif compgen -G "\${ZIP_GLOB}" > /dev/null; then\n  zip_candidates+=( \$(ls -1 \${ZIP_GLOB}) )\nelse\n  # fallback: any zip under build/\n  while IFS= read -r z; do zip_candidates+=("\$z"); done < <(find build -maxdepth 1 -type f -name \'*.zip\' | sort)\nfi\n\nfirst=1\nbuf="["\nfor f in "\${zip_candidates[@]}"; do\n  if out=\$(hash_one "\$f"); then\n    if [[ \$first -eq 0 ]]; then buf+=",\\n"; fi\n    buf+="\$out"\n    first=0\n  fi\ndone\n\n# PDFs\nwhile IFS= read -r p; do\n  if out=\$(hash_one "\$p"); then\n    if [[ \$first -eq 0 ]]; then buf+=",\\n"; fi\n    buf+="\$out"\n    first=0\n  fi\ndone < <(compgen -G "\${PDF_GLOB}" >/dev/null && ls -1 \${PDF_GLOB} || true)\nbuf+="]"\nartifacts="\$buf"\n\n# build_metadata.json (quick facts)\ncat > "\${OUT_DIR}/build_metadata.json" < META\n\n# release_manifest.json (artifacts + git)\ncat > "\${OUT_DIR}/release_manifest.json" < JSON\n{\n  "version": "\${VERSION}",\n  "tag": "\${TAG}",\n  "commit": "\${commit}",\n  "branch": "\${branch}",\n  "timestamp_utc": "\${utc_now}",\n  "repo": "\${repo_url}",\n  "artifacts": \${artifacts}\n}\nJSON\n\necho "Wrote:"\nls -lh "\${OUT_DIR}/build_metadata.json" "\${OUT_DIR}/release_manifest.json"\nEOT\nchmod +x tools/make_release_manifest.sh; cat > tools/release_now.sh <<\'EOT\'\n#!/usr/bin/env bash\nset -euo pipefail\n\n# 0) Bump version\ntools/bump_version.sh\nVERSION="\$(cat VERSION)"\nTAG="v\${VERSION}"\necho "==> Building \${TAG}"\n\n# 1) (Re)build your PDFs & ZIP (reuse your existing builder command)\n#    If you already have a script, call it here. Example:\n#    python tools/make_installer_card.py\n#    Then package:\nmkdir -p build\nzip -q -r "build/Supersonic_Control_And_Health_Pack_v\${VERSION}.zip" docs/ installer* 2>/dev/null || true\n# If you already create a ZIP elsewhere, this is just a fallback.\n\n# 2) Generate metadata & manifest\ntools/make_release_manifest.sh\n\n# 3) Commit\ngit add -A\ngit commit -m "release(v\${VERSION}): bump, build, and manifest"\n\n# 4) Tag & push (with tags)\ngit tag -a "\${TAG}" -m "SupersonicBuilder \${TAG}"\ngit pull --rebase origin main\ngit push origin main --follow-tags\n\necho "==> Done. Pushed \${TAG}."\nEOT\nchmod +x tools/release_now.sh; git add tools VERSION docs/status; git commit -m "chore: add auto-bump, manifest, and release driver"; git pull --rebase origin main; git push origin main
